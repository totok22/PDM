# PDM - FSAE 低压配电模块电源监控

基于 STM32F103C8T6 的 FSAE 赛车低压 PDM 电源监控固件。该固件负责控制和监控整车的低压供电子系统，通过高精度双路 INA226 传感器实时采集电压、电流、功率，并进行能量累计。可通过 CAN 总线向外实时提供低压供电系统的状态报告。

---

## 硬件资源概述

| 模块 | 硬件规格说明 |
|------|------|
| **MCU 主控** | STM32F103C8T6，8MHz 外部高频晶振 (HSE) + PLL 倍频至 72MHz |
| **通道一：低压总线 (BUS)** | INA226 #1（I2C地址：`0x40`），用于监测 DCDC + 电池 OR-RING 汇合后的总输出。采用 4mΩ 分流电阻 |
| **通道二：低压电池 (BAT)** | INA226 #2（I2C地址：`0x41`），单独监测 7 串磷酸铁锂电池侧。采用 4mΩ 分流电阻 |
| **CAN 通信** | SN65HVD230 收发器，引脚 PA11(RX) / PA12(TX)，波特率配置为 500kbps |
| **I2C 通信** | PB6(SCL) / PB7(SDA)，硬件外设，4.7kΩ 上拉电阻 |
| **串行调试 (UART1)** | PA9(TX) / PA10(RX)，波特率为 115200，提供人类可读的 ASCII 状态监控流 |
| **告警引脚 (ALERT)** | ALERT1 (PA1) 对应总线侧，ALERT2 (PA3) 对应电池侧。10kΩ 外部上拉 |
| **状态指示灯 (LED)** | PB5，低电平点亮，1kΩ 限流，用作心跳/在线指示 |

---

## 软件架构与依赖说明

工程基于 `STM32Cube HAL` 库开发（CubeMX 生成底层配置）：

```text
Core/
├── Inc/
│   ├── driver_ina226.h            # 第三方 LibDriver INA226 独立驱动接口头文件
│   ├── driver_ina226_interface.h  # 针对 STM32 HAL 的底层适配实现 (延时、打印、读写)
│   └── pdm_monitor.h              # PDM 核心业务逻辑 API 以及数据结构
└── Src/
    ├── driver_ina226.c            # LibDriver INA226 驱动核心逻辑
    ├── ina226_interface.c         # I2C 总线读写与 UART Debug 缓冲的胶水层
    ├── pdm_monitor.c              # 时序调度、通道读取、CAN 报文组装发送的核心应用层
    └── main.c                     # 硬件初始化与 While(1) 主任务轮询轮
```

---

## CAN 报文协议

模块周期性按照 **500ms** 的速率在总线上广播两个通道的数据：

| 通道节点 | CAN ID | 说明 |
|------|--------|------|
| **低压总线侧 (INA226 #1)** | `0x300` | 反映低压用电设备整车的消耗负载状态 |
| **低压电池侧 (INA226 #2)** | `0x301` | 反映作为主储能电池的输入供给与余量 |

### 帧格式（每帧 8 字节 Standard ID Data Frame，大端序编排）

| 字节 | 字段语义 | C类型 | 物理单位 | 精度比例 | 失联/异常占位符 |
|------|----------|-------|----------|----------|-----------------|
| `[0:1]` | 电压 | `int16_t` | mV | 1 mV/LSB | `0x7FFF` |
| `[2:3]` | 电流 | `int16_t` | mA | 10 mA/LSB | `0x7FFF` |
| `[4:5]` | 瞬时功率 | `uint16_t` | mW | 100 mW/LSB | `0xFFFF` |
| `[6:7]` | 累计耗电量 | `uint16_t` | mWh | 10 mWh/LSB | `0xFFFF` |

> 当任何一路 I2C 与 INA226 传感器通信超时（接线松动、芯片烧毁等），对应 CAN 报文即刻将全部数值填充为上述的 **脱机异常特殊标志位（如 `0x7FFF`）**。避免外部控制器将故障误判为零值而掩盖风险。

### Python 终端解码参考示例
```python
import struct

# 模拟截获到的 8 字节 CAN Payload
data = bytes([0x5D, 0xC0, 0x00, 0x96, 0x01, 0x68, 0x00, 0x12])
voltage_mV, current_x10, power_x100, energy_x10 = struct.unpack('>hhHH', data)

print(f"Voltage: {voltage_mV} mV")
print(f"Current: {current_x10 * 10} mA")
print(f"Power:   {power_x100 * 100} mW")
print(f"Energy:  {energy_x10 * 10} mWh")
```

---

## 定时调度系统

主循环依靠非阻塞式的时间戳 (`HAL_GetTick()`) 定期进行状态驱动：

* **50 ms:** 通过 I2C 获取最新各路 `电压/电流/功率`，利用时间积分累计瓦时 (mWh)。
* **500 ms:** 在 CAN 总线将最新的节点状态进行组帧发送，并对板载 LED 心跳灯进行翻转。
* **1000 ms:** 根据格式化的 ASCII 报文通过 UART 串口向上位机或调试工具输出当前可读日志。
* **异步中断:** 目前 PA1 / PA3 保留了 ALERT 告警外部中断配置输入源，代码端进行状态清零与占位预留处理，以避免误触中断引起的假死机。

---

## INA226 传感器配置说明

在系统初始化时，代码将对 INA226 芯片写入以下核心配置：

* **采样滤波：** 硬件平均开启，连续取 16 次均值，抑制系统在赛车颠簸或感性负载切换下的尖峰毛刺。
* **总转换时间：** 总线电压 (Bus) 转换时间和分流电压 (Shunt) 转换时间均设置为 `1.1 ms`。
* **分流器阻值：** 标定为 `4mΩ`
* **工作模式：** 主动连续测量模式。

---

## 冗余控制设计

1. **CAN 自动离线接管：** 强制使能 `AutoBusOff` 自动退出以及 `AutoRetransmission` 错误自动重传。面对严重总线冲击时，CAN 不再一睡不醒，而是拥有断线恢复重建会话的能力。即使 TX 邮箱被占满，只会发生静默自守而不再将主循环卡死。
2. **I2C 极速反馈：** 彻底去除 100ms 这种不合理的挂载阻塞时间。将读写响应时间下压到 `10ms` 的硬件上限内，一旦 I2C 遭到外部辐射干扰掉线，主系统能瞬时脱身并发出无效特殊掩码以通报网络，保证 50ms 与 500ms 服务正常运转。
3. **安全能量归零：** 当系统长期通电导致储能量达 `655.35 Wh` 时（换算为满刻度 65535 的 CAN 值），将主动滚动归零而非钳位，保证累计值逻辑一致。
4. **内存防越界校验：** 避免 UART 输出时的底层调用因为字符串缓冲区被栈溢出填爆引发数据乱码。

---

## 编译与烧录指南

1. **环境准备:** 推荐使用装载 ARM GCC 编译链的 **STM32CubeIDE** 工具。
2. **源码挂载:** 确保 `Core/Src/` 和 `Core/Inc/` 中的全部相关源文件都已经引入到当前 IDE 中的构建树视野范围内。
3. **重载 Cube:** 如遇特殊需求打开 CubeMX 的 `.ioc` 并重构代码后，编写代码要紧跟在 `/* USER CODE BEGIN ... */` 和 `/* USER CODE END ... */` 区间内，否则代码会被覆盖。
4. **下载器:** 连接 ST-Link v2 或 DAP-Link 至板载 SWD（SWDIO、SWCLK、GND、3.3V）直通接口，执行 "Build And Debug" 刷写至 Flash 中。

也可以依照Doc\VSCODE编译配置.md进行编译。

## UART 调试协议日志

波特率 115200 8N1，周期：1 Hz 打印（接上串口监听助手即可免上位机显示）：

```txt
BUS: 24000mV 1500.0mA 36000.0mW 18.0mWh | BAT: 22800mV 1480.0mA 33744.0mW 16.9mWh
```
